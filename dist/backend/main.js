var ae=Object.create;var N=Object.defineProperty,le=Object.defineProperties,ce=Object.getOwnPropertyDescriptor,me=Object.getOwnPropertyDescriptors,de=Object.getOwnPropertyNames,F=Object.getOwnPropertySymbols,ue=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty,pe=Object.prototype.propertyIsEnumerable;var O=(s,e,o)=>e in s?N(s,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):s[e]=o,f=(s,e)=>{for(var o in e||={})j.call(e,o)&&O(s,o,e[o]);if(F)for(var o of F(e))pe.call(e,o)&&O(s,o,e[o]);return s},y=(s,e)=>le(s,me(e));var ge=(s,e,o,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of de(e))!j.call(s,t)&&t!==o&&N(s,t,{get:()=>e[t],enumerable:!(i=ce(e,t))||i.enumerable});return s};var p=(s,e,o)=>(o=s!=null?ae(ue(s)):{},ge(e||!s||!s.__esModule?N(o,"default",{value:s,enumerable:!0}):o,s));var a=(s,e,o)=>new Promise((i,t)=>{var n=m=>{try{l(o.next(m))}catch(d){t(d)}},r=m=>{try{l(o.throw(m))}catch(d){t(d)}},l=m=>m.done?i(m.value):Promise.resolve(m.value).then(n,r);l((o=o.apply(s,e)).next())});var M=p(require("express")),te=p(require("http")),C=p(require("path")),oe=p(require("dotenv"));var P=require("socket.io");var J=require("mongodb");var fe="mongodb://localhost:27017",he="you_need";function c(s){return a(this,null,function*(){let e=new J.MongoClient(fe);return yield e.connect(),console.log("Connected successfully to server"),{collection:e.db(he).collection(s),client:e}})}function $(s){new P.Server(s,{cors:{origin:"http://localhost:4200"}}).on("connection",o=>{console.log(o.id," connected");let i;o.on("start_timer",t=>{let n={hours:0,minutes:0,seconds:0};i=setInterval(()=>{n.seconds+=1,n.seconds===60&&(n.minutes+=1,n.seconds=0),n.minutes===60&&(n.hours+=1,n.minutes=0);let r=n.hours.toString(),l=n.minutes.toString(),m=n.seconds.toString(),d={hours:r.length<2?"0"+n.hours:r,minutes:l.length<2?"0"+n.minutes:l,seconds:m.length<2?"0"+n.seconds:m};o.to(t.sender_id).emit("start_timer",d),o.to(t.receiver_id).emit("start_timer",d)},10)}),o.on("stop_timer",()=>{clearInterval(i)}),o.emit("connected",o.id),o.on("toServer",t=>{o.emit("fromServer",t)}),o.on("mediaStreamInfo",({id:t,video:n})=>{o.to(t).emit("mediaStreamInfo",n)}),o.on("call",t=>{o.to(t.call.receiver_id).emit("call",t)}),o.on("accept-call",t=>{o.to(t.call.sender_id).emit("accept-call",t)}),o.on("message",t=>a(this,null,function*(){let r=yield(yield c("meetings")).collection.findOne({id:t});console.log(r),r==null||r.members.forEach(l=>{console.log(l),o.to(l).emit("message",t)})})),o.on("p2p-accept-call",t=>{o.to(t.call.sender_id).emit("p2p-accept-call",t)}),o.on("decline-call",t=>{o.to(t.call.sender_id).emit("decline-call",t),o.to(t.call.receiver_id).emit("decline-call",t)}),o.on("joinRoom",t=>{console.log("Join room: ",t),o.join(t)}),o.on("leaveRoom",t=>{console.log("Leave room: ",t),o.leave(t)}),o.on("pushNotification",t=>{o.to(t.recipient).emit("pushNotification",t)}),o.on("p2p_user_media_message",t=>{console.log(t),o.to(t.id).emit("p2p_user_media_message",{type:t.type,message:f({type:t.type},t.message)})}),o.on("p2p_display_media_message",t=>{console.log("display ",t),o.to(t.id).emit("p2p_display_media_message",{type:t.type,message:f({type:t.type},t.message)})})})}var ne=p(require("cors")),se=p(require("fs")),ie=require("express-json-validator-middleware");var A=require("express-json-validator-middleware");function E(s,e,o,i){var t;if(s instanceof A.ValidationError){let n=(t=s.validationErrors.body)==null?void 0:t[0],r=(()=>{switch(n==null?void 0:n.keyword){case"type":return((n==null?void 0:n.instancePath)||"Object")+" "+(n==null?void 0:n.message);case"additionalProperties":return((n==null?void 0:n.instancePath)||"Object")+" "+n.message+": "+(n==null?void 0:n.params.additionalProperty);default:return((n==null?void 0:n.instancePath)||"Object")+" "+(n==null?void 0:n.message)}})();o.status(400).send({error:n==null?void 0:n.keyword,message:"Validation failed"}),o.end()}else i(s)}var I=p(require("jsonwebtoken"));function v(s){s.locals.user=void 0}function T(s,e,o){let i=s.headers.authentication,t="supercat";if(t){I.verify((i==null?void 0:i.toString())||"",t,(n,r)=>{if(n)switch(s.method){case"GET":if(s.originalUrl!=="/auth"){v(e),e.redirect("/auth"),e.end();return}return o();case"POST":switch(s.originalUrl){case"/auth":o();return;case"/register":o();return;default:v(e),e.sendStatus(401),e.end();return}default:v(e),e.sendStatus(401),e.end()}return e.locals.user=r,o()});return}v(e),e.sendStatus(502),e.end()}function V(s,e,o){if(s.body){let{meeting_id:i}=s.body;if(!i){console.log("meeting_id not found");return}c("messages").then(t=>a(this,null,function*(){let n=yield t.collection.find({meeting_id:i}).toArray();return e.status(200),e.send(n),e.end(),t})).then(t=>a(this,null,function*(){yield t.client.close()})).catch(t=>(console.error(t),e.status(502),e.end(),new Error("Any error")))}}var W=require("uuid");function ye(){let s=["\u042F\u043D\u0432\u0430\u0440\u044C","\u0424\u0435\u0432\u0440\u0430\u043B\u044C","\u041C\u0430\u0440\u0442","\u0410\u043F\u0440\u0435\u043B\u044C","\u041C\u0430\u0439","\u0418\u044E\u043D\u044C","\u0418\u044E\u043B\u044C","\u0410\u0432\u0433\u0443\u0441\u0442","\u0421\u0435\u043D\u0442\u044F\u0431\u0440\u044C","\u041D\u043E\u044F\u0431\u0440\u044C","\u0414\u0435\u043A\u0430\u0431\u0440\u044C"],e=new Date,o=e.getDate(),i=e.getMonth()-1,t=e.getHours().toString(),n=e.getMinutes().toString(),r=`${t.length>1?t:"0"+t}`,l=`${n.length>1?n:"0"+n}`,m=r+":"+l;return{date:`${o} ${s[i]}`,time:m,full_date:e}}function D(s,e,o){let i=e.locals.user,{meeting_id:t,type:n,receivers:r,message:l,attachments:m}=s.body;console.log(s.body);let{date:d,time:_,full_date:g}=ye();c("meetings").then(u=>{let h=(0,W.v4)();return r&&r.length?(u.collection.insertOne({id:h,type:r.length<=2?"private":"group",members:[...r,i.id],last_message:y(f({meeting_id:h},s.body),{sender_id:i.id,date:d,time:_,full_date:g,status:"sent"}),unread_messages_count:0}).then(console.log).catch(console.error),{id:h,data:u}):{id:t,data:u}}).then(u=>(c("messages").then(h=>a(this,null,function*(){let R=y(f({meeting_id:u.id},s.body),{sender_id:i.id,date:d,time:_,full_date:g,status:"sent"});yield h.collection.insertOne(R),yield u.data.collection.updateOne({id:u.id},{$set:{last_message:R}}),e.send(R)})).then(console.log).catch(h=>console.error("messages",h)),u)).catch(u=>console.error("meetings",u))}var z=require("uuid"),U=p(require("argon2"));function H(s,e,o){return a(this,null,function*(){if(s.body){let i="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fd/Faenza-avatar-default-symbolic.svg/1024px-Faenza-avatar-default-symbolic.svg.png",t=y(f({id:(0,z.v4)()},s.body),{image:i,password:yield U.hash(s.body.password),service_price:2e3,access:!0,access_rights:"user"});console.log(t),c("users").then(n=>a(this,null,function*(){if(yield n.collection.findOne({email:s.body.email}))e.status(200),e.send({error:"Email already exist",message:"Denied"}),e.end();else{let l=yield n.collection.insertOne(t);e.status(200),e.send({message:"User register successful"}),e.end()}return n})).then(n=>a(this,null,function*(){yield n.client.close()})).catch(n=>(console.error(n.errInfo.details.clausesNotSatisfied[0]),e.status(502),e.end(),new Error("Any error"))).finally(()=>console.log("Users register finally"))}})}var Z=p(require("argon2")),w=p(require("jsonwebtoken"));function G(s,e,o){let i="supercat";if(s.body&&i){let t=s.body;c("users").then(n=>a(this,null,function*(){let r=yield n.collection.findOne({email:t.email});if(r&&(yield Z.verify(r.password,t.password))&&t.email===r.email){let l={id:r.id,first_name:r.first_name,last_name:r.last_name,email:r.email,image:r.image,service_price:r.service_price};w.sign(l,i,{expiresIn:60*60},(m,d)=>{if(console.log(d),d){w.verify(d,i,(_,g)=>{e.setHeader("Authentication",d),e.status(200),e.send({message:g}),e.end()});return}e.status(502),e.send({message:"Server can't proceed request"}),e.end()})}else e.status(401),e.send({error:"Unauthorized",message:"Invalid email or password"}),e.end();return n})).then(n=>a(this,null,function*(){yield n.client.close()})).catch(n=>(console.error(n),e.status(502),e.end(),new Error("Any error"))).finally(()=>console.log("Users auth finally"))}}var S=p(require("express-brute"));function B(s,e,o){return a(this,null,function*(){c("users").then(i=>a(this,null,function*(){let t=yield i.collection.find({id:{$ne:e.locals.user.id}},{projection:{_id:0,password:0}}).toArray();if(t){e.send({message:t}),e.end();return}e.sendStatus(404),e.end()}))})}function L(s,e,o){return a(this,null,function*(){let i=yield c("users"),n=yield(yield c("meetings")).collection.find({members:{$in:[e.locals.user.id]}},{projection:{_id:0}}).toArray();for(let r=0;r<n.length;r++)for(let l=0;l<n[r].members.length;l++)n[r].members[l]=yield i.collection.findOne({id:n[r].members[l]},{projection:{_id:0,password:0}});console.log(n),e.send({message:n})})}function Q(s,e,o){return a(this,null,function*(){if(s.body){let t=yield(yield c("users")).collection.findOne({id:s.body.id});if(t){e.send(t),e.end();return}}e.send(e.locals.user),e.end()})}var x=class{constructor(e,o,i,t){this._router=e,this._route=o,this._collection=i.collection,this._client=i.client,this._validator=t,this._mongo_data=i,this.init()}get(e,o,i){return a(this,null,function*(){})}post(e,o,i){return a(this,null,function*(){})}put(e,o,i){return a(this,null,function*(){})}patch(e,o,i){return a(this,null,function*(){})}delete(e,o,i){return a(this,null,function*(){})}validate(e,o,i){let t=e.method.toLowerCase(),n=this._validator[t];if(!(e.body instanceof Object&&Object.keys(e.body).length)&&t!=="get"){o.status(200).send({error:"Invalid body"}).end();return}if(n)return n(e,o,i);i()}init(){this._router.get(`${this._route.name}${this._route.params.map(e=>`/:${e}`).join("")}`,this.get.bind(this)),this._router.route(this._route.name).all(this.validate.bind(this)).post(this.post.bind(this)).put(this.put.bind(this)).patch(this.patch.bind(this)).delete(this.delete.bind(this))}};var K=require("uuid");function Y(){let s=new Date,e=s.getDate().toString(),o=(1+s.getMonth()).toString(),i=e.length<2?"0"+e:e,t=s.getSeconds().toString(),n=t.length<2?"0"+t:t,r=s.getMinutes().toString(),l=r.length<2?"0"+r:r,m=s.getHours().toString(),d=m.length<2?"0"+m:m,_=i+"."+o+"."+s.getFullYear(),g=d+":"+l+":"+n;return{date:_,time:g,full_date:s}}var b=class extends x{constructor(e,o,i,t){super(e,o,i,t)}get(e,o,i){return a(this,null,function*(){if(!e.params.meeting_id||!+e.params.meeting_id){try{let t=yield this._collection.find({},{projection:{_id:0}}).sort({_id:+e.params.last?-1:1}).limit(+e.params.limit||50).toArray().then(n=>JSON.parse(JSON.stringify(n)));+e.params.last&&t.reverse(),t.length?o.status(200).send({data:t}):o.status(200).send({data:null}),o.end()}catch(t){o.status(500).send({error:t}).end()}return}try{let t=yield this._collection.find({meeting_id:e.params.meeting_id},{projection:{_id:0}}).sort({_id:+e.params.last?-1:1}).limit(+e.params.limit||50).toArray().then(n=>JSON.parse(JSON.stringify(n)));+e.params.last&&t.reverse(),t.length?o.status(200).send({data:t}):o.status(200).send({data:null}),o.end()}catch(t){o.status(500).send({error:t}).end()}})}post(e,o,i){return a(this,null,function*(){try{let{date:t,time:n,full_date:r}=Y(),l=new Date(r);l.setMilliseconds(12*60*60*1e3);let m=e.body.meeting_id,g=yield(yield(yield c("meetings")).collection).findOne({id:m},{projection:{_id:0}});if(g){let u=g.members,h=g.type,R=u.filter(re=>re!==o.locals.user.id);console.log(o.locals.user.id);let q={id:(0,K.v4)(),meeting_id:m,type:h,date:t,time:n,full_date:r,expires:l,members:u,experts:R,status:"active"};yield this._collection.insertOne(q),o.status(200).send({data:q}).end();return}throw new Error}catch(t){o.status(500).send({error:t}).end()}})}patch(e,o,i){return a(this,null,function*(){try{let t=e.body.members?[o.locals.user.id,...e.body.members]:void 0;yield this._collection.updateOne({id:e.body.id},{$set:t?y(f({},e.body),{type:t.length>2?"group":"private",members:t}):e.body});let n=yield this._collection.findOne({id:e.body.id});o.status(200).send({data:JSON.parse(JSON.stringify(n))}).end()}catch(t){o.status(500).send({error:t}).end()}})}delete(e,o,i){return a(this,null,function*(){try{let t=yield this._collection.findOne({id:e.body.id});yield this._collection.deleteOne({id:e.body.id}),o.status(200).send({data:JSON.parse(JSON.stringify(t))}).end()}catch(t){o.status(500).send({error:t}).end()}})}};var X={type:"object",properties:{email:{type:"string",pattern:"^[a-zA-Z\u0430-\u044F\u0410-\u042F0-9_@.-]+$"},password:{type:"string"}},additionalProperties:!1,required:["email","password"],$schema:"http://json-schema.org/draft-07/schema#"};var k={type:"object",properties:{first_name:{type:"string",pattern:"^[a-zA-Z\u0430-\u044F\u0410-\u042F]+$"},last_name:{type:"string",pattern:"^[a-zA-Z\u0430-\u044F\u0410-\u042F]+$"},email:{type:"string",pattern:"^[a-zA-Z\u0430-\u044F\u0410-\u042F0-9_@.-]+$"},password:{type:"string"}},additionalProperties:!1,required:["email","first_name","last_name","password"],$schema:"http://json-schema.org/draft-07/schema#"};oe.config({path:C.resolve(__dirname,"./.env")});var ee=4e3,ve=s=>a(exports,null,function*(){let e=yield c(s);return{collection:yield e.collection,client:yield e.client}});(function(){return a(this,null,function*(){let s=(0,M.default)(),e=te.createServer(s);$(e);let{validate:o}=new ie.Validator({}),i=n=>JSON.parse(se.readFileSync(__dirname+"/models"+n).toString()),t=n=>{let r=new S.default.MemoryStore;return new S.default(r,n).prevent};s.use(M.default.static(C.resolve(__dirname,"../dist"))),s.use(M.default.json()),s.use((0,ne.default)({origin:["http://localhost:4200"],exposedHeaders:["Authentication"]})),s.use(T),s.use("/auth",t({freeRetries:1})),s.use("/register",t({freeRetries:1})),s.use("/messages",t({freeRetries:80})),new b(s,{name:"/call",params:["meeting_id?","limit?","last?"]},yield ve("calls"),{}),s.post("/user",Q),s.post("/meetings",L),s.post("/users",B),s.post("/auth",o({body:X}),G),s.post("/register",o({body:k}),H),s.post("/messages",V),s.post("/message",D),s.use(E),e.listen(ee,()=>{console.log(`You-Need server listening on port: ${ee}`)})})})();
